# –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ v2: –£–ª—É—á—à–µ–Ω–∏—è –∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

**–í–µ—Ä—Å–∏—è:** 2.0  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 18.01.2026  
**–°—Ç–∞—Ç—É—Å:** üìã –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–≠—Ç–æ—Ç –ø–ª–∞–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ (–§–∞–∑—ã 0-5).

**–ò—Å—Ç–æ—á–Ω–∏–∫:** –ó–∞–º–µ—á–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç 18.01.2026

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** ~2-3 –Ω–µ–¥–µ–ª–∏

```
–§–∞–∑–∞ 6: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ [~1 –Ω–µ–¥–µ–ª—è]
    ‚Üì
–§–∞–∑–∞ 7: –£—á—ë—Ç –ø–ª–∞—Ç–µ–∂–µ–π –∏ –±–∞–ª–∞–Ω—Å [~1 –Ω–µ–¥–µ–ª—è]
    ‚Üì
–§–∞–∑–∞ 8: –£–ª—É—á—à–µ–Ω–∏—è UX [~3-5 –¥–Ω–µ–π]
```

---

## –§–∞–∑–∞ 6: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ ‚≠ê‚≠ê‚≠ê

**–¶–µ–ª—å:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±–µ–¥–æ–≤ –∏ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é

**–í—Ä–µ–º—è:** ~1 –Ω–µ–¥–µ–ª—è

---

### –®–∞–≥ 6.1: –û–±–µ–¥—ã –∫–∞–∫ –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

**–ó–∞–¥–∞—á–∞:** –¢–µ–∫—É—â–∏–π/–ø–æ–∑–¥–Ω–∏–π –æ–±–µ–¥ –ù–ï —É—Å–ª—É–≥–∞, –∞ +1 —á–∞—Å –∫ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–µ

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –û–±–µ–¥—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `additional_services` –∫–∞–∫ —É—Å–ª—É–≥–∏
- –ò–º–µ—é—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
- –ù–µ –≤–ª–∏—è—é—Ç –Ω–∞ —á–∞—Å—ã –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `meal_types`
- –û–±–µ–¥—ã –¥–æ–±–∞–≤–ª—è—é—Ç —á–∞—Å—ã –∫ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–µ
- –°—Ç–æ–∏–º–æ—Å—Ç—å = –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –∑–∞ —ç—Ç–∏ —á–∞—Å—ã

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `meal_types`:**
```python
# –í database.py -> init_db()
await db.execute("""
    CREATE TABLE IF NOT EXISTS meal_types (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        profession_id INTEGER NOT NULL,
        name TEXT NOT NULL,
        adds_overtime_hours REAL DEFAULT 1.0,
        keywords TEXT,
        FOREIGN KEY (profession_id) REFERENCES professions(id)
    )
""")
```

2. **–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `shift_meals` (—Å–≤—è–∑—å —Å–º–µ–Ω –∏ –æ–±–µ–¥–æ–≤):**
```python
await db.execute("""
    CREATE TABLE IF NOT EXISTS shift_meals (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        shift_id INTEGER NOT NULL,
        meal_type_id INTEGER NOT NULL,
        FOREIGN KEY (shift_id) REFERENCES shifts(id),
        FOREIGN KEY (meal_type_id) REFERENCES meal_types(id)
    )
""")
```

3. **–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `database.py`:**
```python
async def add_meal_type(profession_id, name, adds_hours=1.0, keywords=''):
    """–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø –æ–±–µ–¥–∞"""
    
async def get_meal_types(profession_id):
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–∏–ø—ã –æ–±–µ–¥–æ–≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏"""
```

4. **–û–±–Ω–æ–≤–∏—Ç—å `parser.py`:**
- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –æ–±–µ–¥—ã –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç —É—Å–ª—É–≥
- –í–æ–∑–≤—Ä–∞—â–∞—Ç—å `meals: ["—Ç–µ–∫—É—â–∏–π –æ–±–µ–¥", "–ø–æ–∑–¥–Ω–∏–π –æ–±–µ–¥"]`

5. **–û–±–Ω–æ–≤–∏—Ç—å `calculator.py`:**
```python
# –ü–æ–ª—É—á–∞–µ–º –æ–±–µ–¥—ã –∏–∑ parsed_data
meals = parsed_data.get("meals", [])

# –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø—ã –æ–±–µ–¥–æ–≤ –∏–∑ –ë–î
meal_types = await get_meal_types(profession_id)

# –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Å—ã –∫ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–µ
meal_hours = 0
for meal_name in meals:
    for meal_type in meal_types:
        if meal_name.lower() in meal_type["name"].lower():
            meal_hours += meal_type["adds_overtime_hours"]

# –î–æ–±–∞–≤–ª—è–µ–º –∫ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–µ
total_overtime_hours = base_overtime_hours + meal_hours
```

6. **–û–±–Ω–æ–≤–∏—Ç—å `handlers/shifts.py`:**
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–±–µ–¥—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
```
üçΩ –û–±–µ–¥—ã:
   ‚Ä¢ –¢–µ–∫—É—â–∏–π –æ–±–µ–¥ (+1—á)
   ‚Ä¢ –ü–æ–∑–¥–Ω–∏–π –æ–±–µ–¥ (+1—á)
```

7. **–û–±–Ω–æ–≤–∏—Ç—å Mini App:**
- –£–±—Ä–∞—Ç—å –æ–±–µ–¥—ã –∏–∑ —Ñ–æ—Ä–º—ã "–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É"
- –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É "–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø –æ–±–µ–¥–∞" (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å —É—Å–ª—É–≥–∞–º–∏)

8. **–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:**
- –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±–µ–¥—ã –∏–∑ `additional_services` –≤ `meal_types`
- –£–¥–∞–ª–∏—Ç—å –æ–±–µ–¥—ã –∏–∑ `additional_services`

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ –û–±–µ–¥—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
- ‚úÖ AI —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –æ–±–µ–¥—ã –æ—Ç–¥–µ–ª—å–Ω–æ
- ‚úÖ –û–±–µ–¥—ã –¥–æ–±–∞–≤–ª—è—é—Ç —á–∞—Å—ã –∫ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–µ
- ‚úÖ –°—Ç–æ–∏–º–æ—Å—Ç—å = –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –∑–∞ —ç—Ç–∏ —á–∞—Å—ã

**–ö–æ–º–º–∏—Ç:** `git commit -m "–®–∞–≥ 6.1: –û–±–µ–¥—ã –∫–∞–∫ –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (+1 —á–∞—Å)"`

---

### –®–∞–≥ 6.2: –£–±—Ä–∞—Ç—å "–Ω–µ—Ç—Ç–æ/–±—Ä—É—Ç—Ç–æ"

**–ó–∞–¥–∞—á–∞:** –ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –Ω–∞ –ø–æ–Ω—è—Ç–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–ó–∞–º–µ–Ω—ã:**
- "–Ω–µ—Ç—Ç–æ" ‚Üí "—á–∏—Å—Ç—ã–º–∏"
- "–±—Ä—É—Ç—Ç–æ" ‚Üí "—Å –Ω–∞–ª–æ–≥–æ–º"
- "gross" ‚Üí "—Å –Ω–∞–ª–æ–≥–æ–º"
- "net" ‚Üí "—á–∏—Å—Ç—ã–º–∏"
- "tax" ‚Üí "–Ω–∞–ª–æ–≥"

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–û–±–Ω–æ–≤–∏—Ç—å `handlers/shifts.py`:**
```python
# –ë—ã–ª–æ:
text = f"üí∞ –ò—Ç–æ–≥–æ (–Ω–µ—Ç—Ç–æ): {total_net:,}‚ÇΩ"
text += f"üí∞ –ò—Ç–æ–≥–æ (–±—Ä—É—Ç—Ç–æ): {total_gross:,}‚ÇΩ"

# –°—Ç–∞–ª–æ:
text = f"üí∞ –ò—Ç–æ–≥–æ —á–∏—Å—Ç—ã–º–∏: {total_net:,}‚ÇΩ"
text += f"üí∞ –° –Ω–∞–ª–æ–≥–æ–º: {total_gross:,}‚ÇΩ"
text += f"üí∞ –ù–∞–ª–æ–≥: {total_gross - total_net:,}‚ÇΩ"
```

2. **–û–±–Ω–æ–≤–∏—Ç—å `miniapp/add-profession.js`:**
```javascript
// –ë—ã–ª–æ: "–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ (–Ω–µ—Ç—Ç–æ)"
// –°—Ç–∞–ª–æ: "–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ (—á–∏—Å—Ç—ã–º–∏)"
```

3. **–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã Mini App:**
- `add-profession.html`
- `add-service.html`
- `project-details.js`
- `statistics.js`

4. **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ:**
```python
# –ë—ã–ª–æ: base_rate_net
# –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: "–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –Ω–µ—Ç—Ç–æ"

# –°—Ç–∞–ª–æ: base_rate_net
# –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: "–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ —á–∏—Å—Ç—ã–º–∏"
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ –í–æ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö –Ω–µ—Ç —Å–ª–æ–≤ "–Ω–µ—Ç—Ç–æ/–±—Ä—É—Ç—Ç–æ"
- ‚úÖ –í–µ–∑–¥–µ "—á–∏—Å—Ç—ã–º–∏" / "—Å –Ω–∞–ª–æ–≥–æ–º" / "–Ω–∞–ª–æ–≥"

**–ö–æ–º–º–∏—Ç:** `git commit -m "–®–∞–≥ 6.2: –£–±—Ä–∞–Ω–∞ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è –Ω–µ—Ç—Ç–æ/–±—Ä—É—Ç—Ç–æ"`

---

## –§–∞–∑–∞ 7: –£—á—ë—Ç –ø–ª–∞—Ç–µ–∂–µ–π –∏ –±–∞–ª–∞–Ω—Å ‚≠ê‚≠ê

**–¶–µ–ª—å:** –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ –∏ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏

**–í—Ä–µ–º—è:** ~1 –Ω–µ–¥–µ–ª—è

---

### –®–∞–≥ 7.1: –¢–∞–±–ª–∏—Ü–∞ payments –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**–ó–∞–¥–∞—á–∞:** –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —É—á—ë—Ç–∞ –ø–ª–∞—Ç–µ–∂–µ–π

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `payments`:**
```python
# –í database.py -> init_db()
await db.execute("""
    CREATE TABLE IF NOT EXISTS payments (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        project_id INTEGER NOT NULL,
        amount INTEGER NOT NULL,
        date DATE NOT NULL,
        original_message TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (project_id) REFERENCES projects(id)
    )
""")
```

2. **–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `payment_allocations` (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞):**
```python
await db.execute("""
    CREATE TABLE IF NOT EXISTS payment_allocations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        payment_id INTEGER NOT NULL,
        type TEXT NOT NULL,
        amount_clean INTEGER NOT NULL,
        amount_tax INTEGER NOT NULL,
        description TEXT,
        FOREIGN KEY (payment_id) REFERENCES payments(id)
    )
""")
```
–ì–¥–µ `type` = 'profession' –∏–ª–∏ 'service'

3. **–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `database.py`:**
```python
async def create_payment(project_id, amount, date, original_message):
    """–°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂"""

async def get_project_payments(project_id):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –ø—Ä–æ–µ–∫—Ç–∞"""

async def allocate_payment(payment_id, type, amount_clean, amount_tax, description):
    """–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–ª–∞—Ç—ë–∂ (–∑–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é/—É—Å–ª—É–≥–∏)"""

async def get_project_balance(project_id):
    """
    –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø—Ä–æ–µ–∫—Ç–∞
    
    Returns:
        {
            'earned_profession_clean': int,
            'earned_profession_tax': int,
            'earned_services_clean': int,
            'earned_services_tax': int,
            'paid_total': int,
            'paid_profession': int,
            'paid_services': int,
            'balance': int,
            'debt_profession': int,
            'debt_services': int
        }
    """
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

**–ö–æ–º–º–∏—Ç:** `git commit -m "–®–∞–≥ 7.1: –¢–∞–±–ª–∏—Ü—ã payments"`

---

### –®–∞–≥ 7.2: AI-–ø–∞—Ä—Å–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π

**–ó–∞–¥–∞—á–∞:** –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø—Ä–∏—Ö–æ–¥–µ –¥–µ–Ω–µ–≥

**–ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π:**
- "–ø—Ä–∏—à–ª–æ 100 000 —Ä—É–± –ø—Ä–æ–µ–∫—Ç –¢–µ—Å—Ç"
- "–ø–æ–ª—É—á–∏–ª 50 —Ç—ã—Å—è—á –Ω–∞ –ø—Ä–æ–µ–∫—Ç –ö–∏–Ω–æ"
- "100000 –Ω–∞ –¢–µ—Å—Ç"

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–°–æ–∑–¥–∞—Ç—å `payment_parser.py`:**
```python
async def parse_payment_message(
    message: str,
    current_date: str,
    user_projects: list
) -> dict:
    """
    –ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ
    
    Returns:
        {
            "amount": 100000,
            "project_name": "–¢–µ—Å—Ç",
            "date": "2026-01-18",
            "confidence": 0.95,
            "missing_fields": []
        }
    """
```

2. **–ü—Ä–æ–º–ø—Ç –¥–ª—è OpenAI:**
```python
prompt = f"""–¢—ã ‚Äî –ø–∞—Ä—Å–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–µ–Ω–µ–≥.

–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {current_date}
–ü—Ä–æ–µ–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {[p['name'] for p in user_projects]}

–°–æ–æ–±—â–µ–Ω–∏–µ:
"{message}"

–í–µ—Ä–Ω–∏ JSON:
{{
  "amount": 100000,
  "project_name": "–¢–µ—Å—Ç",
  "date": "YYYY-MM-DD",
  "confidence": 0.95,
  "missing_fields": []
}}

–ü—Ä–∞–≤–∏–ª–∞:
1. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Å—É–º–º: "100 000", "100000", "100–∫", "100 —Ç—ã—Å—è—á"
2. –ò—â–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
3. –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –Ω–µ —É–∫–∞–∑–∞–Ω - missing_fields += ["project_name"]
4. –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
"""
```

3. **–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ `handlers/payments.py`:**
```python
from payment_parser import parse_payment_message

@router.message(F.text.lower().contains("–ø—Ä–∏—à–ª–æ") | F.text.lower().contains("–ø–æ–ª—É—á–∏–ª"))
async def handle_payment_message(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö"""
    # –ü–∞—Ä—Å–∏–Ω–≥
    # –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –Ω–µ —É–∫–∞–∑–∞–Ω - —Å–ø—Ä–æ—Å–∏—Ç—å
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞—Ç—ë–∂
    # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ –±–∞–ª–∞–Ω—Å
    # –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ AI —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —Å—É–º–º—ã –∏ –ø—Ä–æ–µ–∫—Ç—ã
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –≤ –ë–î

**–ö–æ–º–º–∏—Ç:** `git commit -m "–®–∞–≥ 7.2: AI-–ø–∞—Ä—Å–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π"`

---

### –®–∞–≥ 7.3: –†–∞—Å—á—ë—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏ –±–∞–ª–∞–Ω—Å–∞

**–ó–∞–¥–∞—á–∞:** –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞ —á—Ç–æ –æ–Ω –ø—Ä–∏—à—ë–ª

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ —Å–º–µ–Ω—ã –ø—Ä–æ–µ–∫—Ç–∞
2. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å:
   - –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é (—á–∏—Å—Ç—ã–º–∏)
   - –ù–∞–ª–æ–≥ —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
   - –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ —É—Å–ª—É–≥–∏ (—á–∏—Å—Ç—ã–º–∏)
   - –ù–∞–ª–æ–≥ —Å —É—Å–ª—É–≥
3. –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ >= –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å - –∑–∞–∫—Ä—ã—Ç—å –≤—Å—ë
4. –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ < –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–°–æ–∑–¥–∞—Ç—å `payment_calculator.py`:**
```python
async def calculate_payment_distribution(project_id: int, payment_amount: int):
    """
    –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
    
    Returns:
        {
            'total_owed_clean': int,
            'total_owed_tax': int,
            'total_owed': int,
            'profession_owed_clean': int,
            'profession_owed_tax': int,
            'services_owed_clean': int,
            'services_owed_tax': int,
            'profession_paid_clean': int,
            'profession_paid_tax': int,
            'services_paid_clean': int,
            'services_paid_tax': int,
            'balance_after': int
        }
    """
```

2. **–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:**
```python
# 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç—É
earned_prof_clean = SUM(earnings.base_pay + earnings.overtime_pay)
earned_prof_tax = earned_prof_clean * (tax_profession / (100 - tax_profession))

earned_serv_clean = SUM(earnings.services_pay)
# –î–ª—è –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–∏ —Å–≤–æ–π –Ω–∞–ª–æ–≥!
earned_serv_tax = SUM(service_cost * (tax_service / (100 - tax_service)))

# 2. –ü–æ–ª—É—á–∞–µ–º —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–µ
paid_total = SUM(payments.amount)

# 3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–æ–ª–≥
total_owed = (earned_prof_clean + earned_prof_tax + 
              earned_serv_clean + earned_serv_tax) - paid_total

# 4. –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂
if payment_amount >= total_owed:
    # –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤–µ—Å—å –¥–æ–ª–≥
    profession_paid = earned_prof_clean + earned_prof_tax
    services_paid = earned_serv_clean + earned_serv_tax
    balance = payment_amount - total_owed
else:
    # –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    prof_ratio = (earned_prof_clean + earned_prof_tax) / total_owed
    serv_ratio = (earned_serv_clean + earned_serv_tax) / total_owed
    
    profession_paid = int(payment_amount * prof_ratio)
    services_paid = int(payment_amount * serv_ratio)
    balance = 0
```

3. **–û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:**
```python
# –í handlers/payments.py
async def handle_payment_message(message: Message):
    # ... –ø–∞—Ä—Å–∏–Ω–≥ ...
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
    distribution = await calculate_payment_distribution(project_id, amount)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞—Ç—ë–∂
    payment_id = await create_payment(project_id, amount, date, message.text)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
    await allocate_payment(
        payment_id, 'profession',
        distribution['profession_paid_clean'],
        distribution['profession_paid_tax'],
        '–ó–∞ —Ä–∞–±–æ—Ç—É'
    )
    await allocate_payment(
        payment_id, 'service',
        distribution['services_paid_clean'],
        distribution['services_paid_tax'],
        '–ó–∞ —É—Å–ª—É–≥–∏'
    )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
    await message.answer(format_payment_card(distribution))
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü–ª–∞—Ç—ë–∂ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é/—É—Å–ª—É–≥–∏
- ‚úÖ –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –Ω–∞–ª–æ–≥–∞
- ‚úÖ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å

**–ö–æ–º–º–∏—Ç:** `git commit -m "–®–∞–≥ 7.3: –†–∞—Å—á—ë—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π"`

---

### –®–∞–≥ 7.4: –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ –∏ –±–∞–ª–∞–Ω—Å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π

**–ó–∞–¥–∞—á–∞:** –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–ª–∞–Ω—Å–µ

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:**
```python
# –í handlers/payments.py
def format_payment_card(distribution):
    text = f"""‚úÖ –ü–ª–∞—Ç—ë–∂ –ø—Ä–∏–Ω—è—Ç!

üíµ –ü–æ–ª—É—á–µ–Ω–æ: {distribution['payment_amount']:,}‚ÇΩ

üìä –ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –±—ã–ª–∞:
‚Ä¢ –ó–∞ —Ä–∞–±–æ—Ç—É (—á–∏—Å—Ç—ã–º–∏): {distribution['profession_owed_clean']:,}‚ÇΩ
‚Ä¢ –ù–∞–ª–æ–≥: {distribution['profession_owed_tax']:,}‚ÇΩ
‚Ä¢ –ó–∞ —É—Å–ª—É–≥–∏ (—á–∏—Å—Ç—ã–º–∏): {distribution['services_owed_clean']:,}‚ÇΩ
‚Ä¢ –ù–∞–ª–æ–≥: {distribution['services_owed_tax']:,}‚ÇΩ
‚Ä¢ –ò–¢–û–ì–û: {distribution['total_owed']:,}‚ÇΩ

üí∞ –û–ø–ª–∞—á–µ–Ω–æ:
‚Ä¢ –ó–∞ —Ä–∞–±–æ—Ç—É: {distribution['profession_paid_clean'] + distribution['profession_paid_tax']:,}‚ÇΩ
‚Ä¢ –ó–∞ —É—Å–ª—É–≥–∏: {distribution['services_paid_clean'] + distribution['services_paid_tax']:,}‚ÇΩ

"""
    
    if distribution['balance_after'] > 0:
        text += f"‚úÖ –ü–µ—Ä–µ–ø–ª–∞—Ç–∞: {distribution['balance_after']:,}‚ÇΩ\n"
    elif distribution['balance_after'] < 0:
        debt = abs(distribution['balance_after'])
        text += f"‚ö†Ô∏è –û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞: {debt:,}‚ÇΩ\n"
        text += f"   ‚Ä¢ –ó–∞ —Ä–∞–±–æ—Ç—É: {distribution['profession_debt']:,}‚ÇΩ\n"
        text += f"   ‚Ä¢ –ó–∞ —É—Å–ª—É–≥–∏: {distribution['services_debt']:,}‚ÇΩ\n"
    else:
        text += "‚úÖ –ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–∞—à–µ–Ω–∞!\n"
    
    return text
```

2. **–ë–∞–ª–∞–Ω—Å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ Mini App:**
```javascript
// –í miniapp/index.js -> displayProjects()
projects.forEach(project => {
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å
    const balance = await fetch(`${API_URL}/projects/${project.id}/balance`);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–∞—Ä—Ç–æ—á–∫—É
    let balanceText = '';
    if (balance.balance > 0) {
        balanceText = `<p class="project-balance positive">üí∞ –ü–µ—Ä–µ–ø–ª–∞—Ç–∞: ${balance.balance.toLocaleString()}‚ÇΩ</p>`;
    } else if (balance.balance < 0) {
        const debt = Math.abs(balance.balance);
        balanceText = `<p class="project-balance negative">‚ö†Ô∏è –î–æ–ª–≥: ${debt.toLocaleString()}‚ÇΩ</p>`;
    } else {
        balanceText = `<p class="project-balance zero">‚úÖ –ë–∞–ª–∞–Ω—Å: 0‚ÇΩ</p>`;
    }
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ HTML –∫–∞—Ä—Ç–æ—á–∫–∏
});
```

3. **API —ç–Ω–¥–ø–æ–∏–Ω—Ç –±–∞–ª–∞–Ω—Å–∞:**
```python
# –í api_server.py
@app.route('/api/projects/<int:project_id>/balance', methods=['GET'])
def get_project_balance_api(project_id):
    balance = run_async(get_project_balance(project_id))
    return jsonify(balance)
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü—Ä–∏ –ø–ª–∞—Ç–µ–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
- ‚úÖ –ù–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–∏–¥–µ–Ω –±–∞–ª–∞–Ω—Å –ø—Ä–æ–µ–∫—Ç–∞

**–ö–æ–º–º–∏—Ç:** `git commit -m "–®–∞–≥ 7.4: –ë–∞–ª–∞–Ω—Å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–ª–∞—Ç–µ–∂–∞"`

---

## –§–∞–∑–∞ 8: –£–ª—É—á—à–µ–Ω–∏—è UX ‚≠ê

**–¶–µ–ª—å:** –£–ª—É—á—à–∏—Ç—å —É–¥–æ–±—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–í—Ä–µ–º—è:** ~3-5 –¥–Ω–µ–π

---

### –®–∞–≥ 8.1: –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"

**–ó–∞–¥–∞—á–∞:** –î–æ–±–∞–≤–∏—Ç—å BackButton –≤–æ –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã Mini App

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ JS —Ñ–∞–π–ª—ã:**
```javascript
// –í –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ (–∫—Ä–æ–º–µ index.js)
tg.BackButton.show();

tg.BackButton.onClick(function() {
    // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    window.history.back();
});
```

2. **–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
- `create-project.js`
- `project-details.js`
- `add-profession.js`
- `add-service.js`
- `statistics.js`

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ù–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö (–∫—Ä–æ–º–µ –≥–ª–∞–≤–Ω–æ–π) –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
- ‚úÖ –ö–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ö–æ–º–º–∏—Ç:** `git commit -m "–®–∞–≥ 8.1: –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥"`

---

### –®–∞–≥ 8.2: AI –ø–æ–Ω–∏–º–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è

**–ó–∞–¥–∞—á–∞:** "–°–º–µ–Ω–∞ 07:00-19:00 –ø—Ä–æ–µ–∫—Ç –¢–µ—Å—Ç" ‚Üí –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–º–ø—Ç –≤ `parser.py`:**
```python
prompt = f"""...

–ü—Ä–æ–µ–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {[p['name'] for p in user_projects]}

...

–í–µ—Ä–Ω–∏ JSON:
{{
  ...
  "project_name": "–¢–µ—Å—Ç",  # –ù–û–í–û–ï –ü–û–õ–ï
  ...
}}

–ü—Ä–∞–≤–∏–ª–∞:
...
5. –ò—â–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏:
   - "–ø—Ä–æ–µ–∫—Ç –¢–µ—Å—Ç"
   - "–Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ –ö–∏–Ω–æ"
   - "—Ä–∞–±–æ—Ç–∞ –§–∏–ª—å–º"
   –ï—Å–ª–∏ –Ω–∞—à—ë–ª - –≤–µ—Ä–Ω–∏ project_name
   –ï—Å–ª–∏ –Ω–µ –Ω–∞—à—ë–ª - project_name = null
"""
```

2. **–û–±–Ω–æ–≤–∏—Ç—å `handlers/shifts.py`:**
```python
async def handle_text_message(message: Message):
    # ... –ø–∞—Ä—Å–∏–Ω–≥ ...
    
    project = None
    
    # –ï—Å–ª–∏ AI —Ä–∞—Å–ø–æ–∑–Ω–∞–ª –ø—Ä–æ–µ–∫—Ç
    if result.get("project_name"):
        # –ò—â–µ–º –ø—Ä–æ–µ–∫—Ç –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        projects = await get_user_projects(message.from_user.id)
        for p in projects:
            if result["project_name"].lower() in p["name"].lower():
                project = p
                break
        
        if not project:
            # –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
            await message.answer(
                f"ü§î –ü—Ä–æ–µ–∫—Ç '{result['project_name']}' –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\n"
                f"–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–µ–∫—Ç."
            )
    
    # –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
    if not project:
        project = await get_active_project(message.from_user.id)
        
        if not project:
            await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.")
            return
        
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await message.answer(
            f"‚ÑπÔ∏è –ü—Ä–æ–µ–∫—Ç –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º: {project['name']}"
        )
    
    # ... –¥–∞–ª—å—à–µ –∫–∞–∫ –æ–±—ã—á–Ω–æ ...
```

3. **–ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ö–æ–∂–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤:**
```python
# –ù–∞—à–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –ø–æ—Ö–æ–∂–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º
matching_projects = [p for p in projects 
                     if result["project_name"].lower() in p["name"].lower()]

if len(matching_projects) > 1:
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É—Ç–æ—á–Ω–µ–Ω–∏–µ
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text=p["name"],
            callback_data=f"select_project_{p['id']}"
        )] for p in matching_projects
    ])
    
    await message.answer(
        "–ù–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ:",
        reply_markup=keyboard
    )
    return
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ AI —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π (—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º)
- ‚úÖ –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ö–æ–∂–∏—Ö - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∏–µ

**–ö–æ–º–º–∏—Ç:** `git commit -m "–®–∞–≥ 8.2: AI –ø–æ–Ω–∏–º–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç"`

---

### –®–∞–≥ 8.3: –ü–æ—Ä–æ–≥ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö

**–ó–∞–¥–∞—á–∞:** UI –≤ –º–∏–Ω—É—Ç–∞—Ö, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —á–∞—Å–∞—Ö

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–û–±–Ω–æ–≤–∏—Ç—å `add-profession.html`:**
```html
<div class="form-group">
    <label for="overtime-threshold">–ü–æ—Ä–æ–≥ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏</label>
    <input type="number" id="overtime-threshold" value="15" step="5">
    <span class="hint">–º–∏–Ω—É—Ç (–ø–µ—Ä–≤—ã–µ –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è)</span>
</div>
```

2. **–û–±–Ω–æ–≤–∏—Ç—å `add-profession.js`:**
```javascript
// –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
const overtimeThresholdMinutes = parseInt(document.getElementById('overtime-threshold').value) || 15;
const overtimeThresholdHours = overtimeThresholdMinutes / 60;

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ë–î –≤ —á–∞—Å–∞—Ö
data: {
    ...
    overtime_threshold: overtimeThresholdHours
}
```

3. **–ü—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö:**
```javascript
// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
const thresholdHours = profession.overtime_threshold;
const thresholdMinutes = Math.round(thresholdHours * 60);

document.getElementById('overtime-threshold').value = thresholdMinutes;
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –º–∏–Ω—É—Ç—ã
- ‚úÖ –í –ë–î —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —á–∞—Å–∞—Ö
- ‚úÖ –ü—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ –≤ –º–∏–Ω—É—Ç—ã

**–ö–æ–º–º–∏—Ç:** `git commit -m "–®–∞–≥ 8.3: –ü–æ—Ä–æ–≥ –≤ –º–∏–Ω—É—Ç–∞—Ö"`

---

### –®–∞–≥ 8.4: –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ - 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞

**–ó–∞–¥–∞—á–∞:** –í—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞ –≤–º–µ—Å—Ç–æ –≤–≤–æ–¥–∞ —á–∏—Å–ª–∞

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–û–±–Ω–æ–≤–∏—Ç—å `add-profession.html`:**
```html
<div class="form-group">
    <label for="overtime-rounding">–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏</label>
    <select id="overtime-rounding">
        <option value="1.0">–ü–æ —á–∞—Å–∞–º</option>
        <option value="0.5" selected>–ü–æ –ø–æ–ª—á–∞—Å–∞</option>
        <option value="0.25">–ü–æ 15 –º–∏–Ω—É—Ç</option>
    </select>
</div>
```

2. **–û–±–Ω–æ–≤–∏—Ç—å `add-profession.js`:**
```javascript
const overtimeRounding = parseFloat(document.getElementById('overtime-rounding').value);
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ –í—ã–±–æ—Ä –∏–∑ 3 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ö–æ–º–º–∏—Ç:** `git commit -m "–®–∞–≥ 8.4: –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ - 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞"`

---

### –®–∞–≥ 8.5: –£—Å–ª—É–≥–∞ "–ø—Ä–∏ –¥—Ä—É–≥–æ–π —É—Å–ª—É–≥–µ"

**–ó–∞–¥–∞—á–∞:** –í—ã–±–æ—Ä —Å–≤—è–∑–∞–Ω–Ω–æ–π —É—Å–ª—É–≥–∏ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–û–±–Ω–æ–≤–∏—Ç—å `add-service.html`:**
```html
<div class="form-group">
    <label for="application-rule">–ü—Ä–∞–≤–∏–ª–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è *</label>
    <select id="application-rule">
        <option value="on_mention">–ü—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏</option>
        <option value="every_shift">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫ –∫–∞–∂–¥–æ–π —Å–º–µ–Ω–µ</option>
        <option value="with_service">–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥—Ä—É–≥–æ–π —É—Å–ª—É–≥–∏</option>
    </select>
</div>

<!-- –ù–û–í–û–ï –ü–û–õ–ï (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
<div class="form-group" id="linked-service-group" style="display: none;">
    <label for="linked-service">–°–≤—è–∑–∞–Ω–Ω–∞—è —É—Å–ª—É–≥–∞ *</label>
    <select id="linked-service">
        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ API -->
    </select>
</div>
```

2. **–û–±–Ω–æ–≤–∏—Ç—å `add-service.js`:**
```javascript
// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏
const services = await fetch(`${API_URL}/projects/${projectId}/services`);

// –ó–∞–ø–æ–ª–Ω–∏—Ç—å select
const linkedServiceSelect = document.getElementById('linked-service');
services.forEach(service => {
    const option = document.createElement('option');
    option.value = service.id;
    option.text = service.name;
    linkedServiceSelect.appendChild(option);
});

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª–∞
document.getElementById('application-rule').addEventListener('change', function() {
    const group = document.getElementById('linked-service-group');
    group.style.display = (this.value === 'with_service') ? 'block' : 'none';
});

// –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
const linkedServiceId = (applicationRule === 'with_service') 
    ? parseInt(document.getElementById('linked-service').value)
    : null;
```

3. **–û–±–Ω–æ–≤–∏—Ç—å API:**
```python
# –í api_server.py
@app.route('/api/projects/<int:project_id>/services', methods=['GET'])
def get_services_api(project_id):
    """–ü–æ–ª—É—á–∏—Ç—å —É—Å–ª—É–≥–∏ –ø—Ä–æ–µ–∫—Ç–∞"""
    profession = run_async(get_profession_by_project(project_id))
    if not profession:
        return jsonify({'services': []})
    
    services = run_async(get_additional_services(profession['id']))
    return jsonify({'services': [dict(s) for s in services]})
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ –í—ã–±–æ—Ä —Å–≤—è–∑–∞–Ω–Ω–æ–π —É—Å–ª—É–≥–∏ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
- ‚úÖ –ü–æ–ª–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "with_service"

**–ö–æ–º–º–∏—Ç:** `git commit -m "–®–∞–≥ 8.5: –£—Å–ª—É–≥–∞ –ø—Ä–∏ –¥—Ä—É–≥–æ–π —É—Å–ª—É–≥–µ"`

---

### –®–∞–≥ 8.6: –ö–æ–º–∞–Ω–¥–∞ `/export`

**–ó–∞–¥–∞—á–∞:** –≠–∫—Å–ø–æ—Ä—Ç CSV —á–µ—Ä–µ–∑ –±–æ—Ç–∞ (–±–µ–∑ Mini App)

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–°–æ–∑–¥–∞—Ç—å `handlers/export.py`:**
```python
from aiogram import Router
from aiogram.types import Message, BufferedInputFile
from aiogram.filters import Command
from database import get_user_projects, get_user_shifts
import csv
from io import StringIO

router = Router()

@router.message(Command("export"))
async def cmd_export(message: Message):
    """–≠–∫—Å–ø–æ—Ä—Ç —Å–º–µ–Ω –≤ CSV"""
    projects = await get_user_projects(message.from_user.id)
    
    if not projects:
        await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤")
        return
    
    if len(projects) == 1:
        # –û–¥–∏–Ω –ø—Ä–æ–µ–∫—Ç - —Å—Ä–∞–∑—É —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º
        await export_project(message, projects[0]['id'], projects[0]['name'])
    else:
        # –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(
                text=p["name"],
                callback_data=f"export_{p['id']}"
            )] for p in projects
        ])
        
        await message.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞:",
            reply_markup=keyboard
        )

@router.callback_query(F.data.startswith("export_"))
async def export_project_callback(callback: CallbackQuery):
    project_id = int(callback.data.split("_")[1])
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
    async with aiosqlite.connect(DATABASE_PATH) as db:
        db.row_factory = aiosqlite.Row
        async with db.execute(
            "SELECT name FROM projects WHERE id = ?",
            (project_id,)
        ) as cursor:
            project = await cursor.fetchone()
    
    await export_project(callback.message, project_id, project['name'])
    await callback.answer()

async def export_project(message, project_id, project_name):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ CSV —Ñ–∞–π–ª–∞"""
    # –ü–æ–ª—É—á–∞–µ–º —Å–º–µ–Ω—ã
    async with aiosqlite.connect(DATABASE_PATH) as db:
        db.row_factory = aiosqlite.Row
        async with db.execute("""
            SELECT 
                s.date, s.start_time, s.end_time,
                s.total_hours, s.overtime_hours,
                e.total_net, e.total_gross
            FROM shifts s
            LEFT JOIN earnings e ON e.shift_id = s.id
            WHERE s.project_id = ? AND s.status = 'calculated'
            ORDER BY s.date ASC
        """, (project_id,)) as cursor:
            shifts = await cursor.fetchall()
    
    # –°–æ–∑–¥–∞—ë–º CSV
    output = StringIO()
    writer = csv.writer(output, delimiter=';')
    
    writer.writerow(['–î–∞—Ç–∞', '–ù–∞—á–∞–ª–æ', '–ö–æ–Ω–µ—Ü', '–ß–∞—Å–æ–≤', '–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞', '–ß–∏—Å—Ç—ã–º–∏', '–° –Ω–∞–ª–æ–≥–æ–º'])
    
    for shift in shifts:
        writer.writerow([
            shift['date'],
            shift['start_time'],
            shift['end_time'],
            shift['total_hours'],
            shift['overtime_hours'] or 0,
            shift['total_net'] or 0,
            shift['total_gross'] or 0
        ])
    
    # –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
    total_net = sum(s['total_net'] or 0 for s in shifts)
    total_gross = sum(s['total_gross'] or 0 for s in shifts)
    
    writer.writerow([])
    writer.writerow(['–ò–¢–û–ì–û', '', '', '', '', total_net, total_gross])
    
    csv_data = output.getvalue()
    output.close()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
    filename = f"{project_name.replace(' ', '_')}_shifts.csv"
    file = BufferedInputFile(csv_data.encode('utf-8'), filename=filename)
    
    await message.answer_document(file, caption=f"üìä –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞: {project_name}")
```

2. **–ü–æ–¥–∫–ª—é—á–∏—Ç—å –≤ `bot.py`:**
```python
from handlers import start, projects, shifts, miniapp, export

dp.include_router(export.router)
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ `/export` —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ï—Å–ª–∏ –æ–¥–∏–Ω –ø—Ä–æ–µ–∫—Ç - —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Å—Ä–∞–∑—É
- ‚úÖ –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä
- ‚úÖ CSV —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ —á–∞—Ç

**–ö–æ–º–º–∏—Ç:** `git commit -m "–®–∞–≥ 8.6: –ö–æ–º–∞–Ω–¥–∞ /export"`

---

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏

### –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ 1 (–ø–æ—Å–ª–µ –§–∞–∑—ã 6):
- ‚úÖ –û–±–µ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ +1 —á–∞—Å –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ù–µ—Ç —Ç–µ—Ä–º–∏–Ω–æ–≤ "–Ω–µ—Ç—Ç–æ/–±—Ä—É—Ç—Ç–æ"
- ‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–º–µ–Ω—ã –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã

### –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ 2 (–ø–æ—Å–ª–µ –§–∞–∑—ã 7):
- ‚úÖ –ú–æ–∂–Ω–æ –≤–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ —á–∞—Ç
- ‚úÖ –ü–ª–∞—Ç—ë–∂ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é/—É—Å–ª—É–≥–∏
- ‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å

### –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ 3 (–ø–æ—Å–ª–µ –§–∞–∑—ã 8):
- ‚úÖ –í—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–º–µ—é—Ç –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
- ‚úÖ AI –ø–æ–Ω–∏–º–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ –í—Å–µ —É–ª—É—á—à–µ–Ω–∏—è UX —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ `/export` —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫:**
1. –®–∞–≥ 6.1 (–æ–±–µ–¥—ã) - –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï
2. –®–∞–≥ 6.2 (—Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è)
3. –®–∞–≥ 7.1-7.4 (–ø–ª–∞—Ç–µ–∂–∏ –∏ –±–∞–ª–∞–Ω—Å) - –≤—Å—ë –≤–º–µ—Å—Ç–µ
4. –®–∞–≥ 8.1-8.6 (—É–ª—É—á—à–µ–Ω–∏—è UX) - –ø–æ –æ–¥–Ω–æ–º—É

**–í—Ä–µ–º—è –Ω–∞ –∫–∞–∂–¥—ã–π —à–∞–≥:**
- –®–∞–≥ 6.1: ~2-3 –¥–Ω—è (—Å–ª–æ–∂–Ω—ã–π)
- –®–∞–≥ 6.2: ~1 –¥–µ–Ω—å (–ø—Ä–æ—Å—Ç–æ–π)
- –§–∞–∑–∞ 7: ~1 –Ω–µ–¥–µ–ª—è (—Å—Ä–µ–¥–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏)
- –§–∞–∑–∞ 8: ~3-5 –¥–Ω–µ–π (–ø—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏)

---

**–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∏–Ω–∞—Ç—å! üöÄ**
