# История изменений

## [13.01.2026] Фаза 2 завершена ✅

### Добавлено

**Шаг 2.1: Модуль AI-парсинга**
- Создан файл `parser.py` с функцией `parse_shift_message()`
- Интеграция с OpenAI API (модель gpt-4o-mini)
- Распознавание даты: "вчера", "позавчера", конкретные даты
- Распознавание времени в разных форматах: "7", "07:00", "7 утра"
- Распознавание дополнительных услуг
- Проверка логики времени (смена не может закончиться в будущем)
- Уровень уверенности (confidence) для каждого парсинга

**Шаг 2.2: Обработка текстовых сообщений**
- Создан файл `handlers/shifts.py`
- Обработка любых текстовых сообщений (кроме команд)
- Проверка наличия активного проекта
- Индикатор обработки "⏳ Обрабатываю..."
- Вычисление продолжительности смены
- Карточка подтверждения с кнопками
- Временное хранилище распарсенных смен (`pending_shifts`)

**Шаг 2.3: Таблица shifts в БД**
- Добавлена таблица `shifts` в `database.py`
- Поля: id, project_id, date, start_time, end_time, total_hours, overtime_hours
- Поля: status, original_message, parsed_data, created_at, confirmed_at
- Функции для работы со сменами:
  - `create_shift()` - создание новой смены
  - `confirm_shift()` - подтверждение смены
  - `get_shift()` - получение смены по ID
  - `get_user_shifts()` - список смен проекта
  - `delete_shift()` - удаление смены

**Шаг 2.4: Сохранение подтверждённой смены**
- Обработчик кнопки "✅ Подтвердить"
- Обработчик кнопки "❌ Отменить"
- Обработчик кнопки "✏️ Изменить" (заглушка)
- Сохранение смены в БД со статусом "confirmed"
- Удаление из временного хранилища после подтверждения

**Улучшение парсера (исправление)**
- Улучшен промпт для OpenAI: добавлены примеры, сокращения
- Понимание "поза", "позо" как "позавчера"
- Более гибкая работа с форматами времени
- Функция `find_matching_services()` для умного поиска услуг
- Поиск услуг по частичному совпадению
- Снижен порог confidence с 0.5 до 0.4

### Изменено
- `requirements.txt`: обновлена версия openai с 1.10.0 до 1.54.0
- `bot.py`: добавлен импорт и подключение `shifts.router`
- `handlers/__init__.py`: добавлен импорт `shifts`
- `database.py`: расширен для работы со сменами

### Технические детали
- Используется асинхронный клиент OpenAI
- Парсинг выполняется с temperature=0.1 для точности
- Обработка markdown в ответах AI
- Проверка времени на стороне Python после AI
- Поддержка переходов через полночь в сменах

## [13.01.2026] Фаза 1 завершена ✅

### Добавлено
- Структура проекта (bot.py, config.py, database.py, handlers/)
- Таблица users в БД
- Таблица projects в БД
- Команда /start с выбором типа контрагента
- Обработка кнопок типа контрагента
- Команда /new_project для создания проектов
- FSM (конечный автомат) для диалогов
- Функции для работы с проектами:
  - create_project()
  - get_user_projects()
  - get_active_project()
- Тестовые файлы: test_db.py, test_projects.py

### Исправлено
- Убран DEFAULT 'person' из таблицы users для корректного отображения кнопок

### Технические детали
- Использован MemoryStorage для FSM
- Добавлен роутер projects в bot.py
- Создан пакет handlers с __init__.py

## Контрольные точки

### Контрольная точка 2 (Фаза 2) ✅
- AI-парсинг работает корректно
- Понимает различные форматы записи
- Смены сохраняются в БД
- Подтверждение/отмена работают

### Контрольная точка 1 (Фаза 1) ✅
- Бот запускается и работает
- База данных создаётся автоматически
- Можно создать пользователя и проект
- FSM работает корректно