# История изменений

## [16.01.2026] Фаза 3 завершена ✅

### Добавлено

**Шаг 3.1: Таблицы для настроек профессии**
- Таблица `professions` - основные настройки (ставка, налог, базовые часы, округление)
- Таблица `progressive_rates` - прогрессивные ставки переработки
- Таблица `additional_services` - дополнительные услуги с налогом
- Таблица `shift_services` - связь смен и услуг
- Таблица `earnings` - расчёты заработка по сменам

**Шаг 3.2: Автосоздание профессии**
- При создании проекта автоматически создаётся профессия с настройками
- Прогрессивные ставки: 0-2ч (500₽), 2-4ч (600₽), 4+ч (700₽)
- Дополнительные услуги: обед (500₽), ронин (3,000₽)
- Правила округления: по 0.5 часа, порог 15 минут

**Шаг 3.3: Модуль calculator.py**
- Функция `calculate_shift_earnings()` для расчёта заработка
- Правильный расчёт: умножение часов на БРУТТО ставку
- Применение прогрессивных ставок переработки
- Применение правил округления и порога
- Расчёт услуг с учётом индивидуального налога
- Сохранение детального расчёта в таблицу `earnings`

**Шаг 3.4: Интеграция расчёта в бота**
- Автоматический расчёт при подтверждении смены
- Обновление статуса смены на "calculated"
- Детальная карточка с расчётом:
  - Базовая ставка (нетто/брутто)
  - Переработка с разбивкой по диапазонам
  - Дополнительные услуги (нетто/брутто)
  - Итого (нетто/брутто)

**Шаг 3.5: Финальная проверка**
- Исправлен parser.py - убрана строгая проверка времени
- Пользователь может вносить любые смены (прошедшие, текущие, будущие)
- Проверены все сценарии: короткие, средние, длинные смены

### Исправлено
- **КРИТИЧЕСКОЕ:** Правильный расчёт брутто - теперь умножаем часы на БРУТТО ставку, а не на нетто
- Каждая услуга теперь может иметь свой процент налога (обед и ронин: 15%)
- Убрана блокировка внесения смен с временем в прошлом

### Технические детали
- Все ставки переработки хранятся в нетто, но расчёт идёт через брутто
- Налог для профессии: 13%
- Налог для услуг: 15% (настраивается индивидуально)
- Округление переработки: `ceil(hours / 0.5) * 0.5`
- Порог переработки: если переработка < 0.25ч (15 минут), она не считается

---

## [13.01.2026] Фаза 2 завершена ✅

### Добавлено

**Шаг 2.1: Модуль AI-парсинга**
- Создан файл `parser.py` с функцией `parse_shift_message()`
- Интеграция с OpenAI API (модель gpt-4o-mini)
- Распознавание даты: "вчера", "позавчера", конкретные даты
- Распознавание времени в разных форматах: "7", "07:00", "7 утра"
- Распознавание дополнительных услуг
- Уровень уверенности (confidence) для каждого парсинга

**Шаг 2.2: Обработка текстовых сообщений**
- Создан файл `handlers/shifts.py`
- Обработка любых текстовых сообщений (кроме команд)
- Проверка наличия активного проекта
- Индикатор обработки "⏳ Обрабатываю..."
- Вычисление продолжительности смены
- Карточка подтверждения с кнопками
- Временное хранилище распарсенных смен (`pending_shifts`)

**Шаг 2.3: Таблица shifts в БД**
- Добавлена таблица `shifts` в `database.py`
- Поля: id, project_id, date, start_time, end_time, total_hours, overtime_hours
- Поля: status, original_message, parsed_data, created_at, confirmed_at
- Функции для работы со сменами

**Шаг 2.4: Сохранение подтверждённой смены**
- Обработчик кнопки "✅ Подтвердить"
- Обработчик кнопки "❌ Отменить"
- Обработчик кнопки "✏️ Изменить" (заглушка)
- Сохранение смены в БД со статусом "confirmed"

**Улучшение парсера (исправление)**
- Улучшен промпт для OpenAI
- Понимание "поза", "позо" как "позавчера"
- Более гибкая работа с форматами времени
- Функция `find_matching_services()` для умного поиска услуг
- Снижен порог confidence с 0.5 до 0.4

---

## [13.01.2026] Фаза 1 завершена ✅

### Добавлено
- Структура проекта (bot.py, config.py, database.py, handlers/)
- Таблица users в БД
- Таблица projects в БД
- Команда /start с выбором типа контрагента
- Обработка кнопок типа контрагента
- Команда /new_project для создания проектов
- FSM (конечный автомат) для диалогов
- Функции для работы с проектами

### Исправлено
- Убран DEFAULT 'person' из таблицы users для корректного отображения кнопок

---

## Контрольные точки

### Контрольная точка 3 (Фаза 3) ✅
- Расчёт заработка работает корректно
- Прогрессивные ставки применяются правильно
- Правильный расчёт брутто (умножение на брутто ставку)
- Детальная карточка показывается в боте

### Контрольная точка 2 (Фаза 2) ✅
- AI-парсинг работает корректно
- Понимает различные форматы записи
- Смены сохраняются в БД
- Подтверждение/отмена работают

### Контрольная точка 1 (Фаза 1) ✅
- Бот запускается и работает
- База данных создаётся автоматически
- Можно создать пользователя и проект
- FSM работает корректно